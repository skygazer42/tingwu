ARG TORCH_BASE_IMAGE=pytorch/pytorch:2.6.0-cuda12.4-cudnn9-runtime

FROM ${TORCH_BASE_IMAGE}

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

# 使用官方源 (Docker 内网络通常稳定)
RUN sed -i \
      's|http://archive.ubuntu.com/ubuntu|https://archive.ubuntu.com/ubuntu|g; s|http://security.ubuntu.com/ubuntu|https://security.ubuntu.com/ubuntu|g' \
      /etc/apt/sources.list \
    && (apt-get -o Acquire::Retries=3 update || ( \
          echo "[apt] update failed; falling back to mirrors.aliyun.com" >&2; \
          sed -i 's|https://archive.ubuntu.com/ubuntu|https://mirrors.aliyun.com/ubuntu|g; s|https://security.ubuntu.com/ubuntu|https://mirrors.aliyun.com/ubuntu|g; s|http://archive.ubuntu.com/ubuntu|https://mirrors.aliyun.com/ubuntu|g; s|http://security.ubuntu.com/ubuntu|https://mirrors.aliyun.com/ubuntu|g' /etc/apt/sources.list; \
          apt-get -o Acquire::Retries=3 update)) \
    && apt-get install -y --no-install-recommends \
      ffmpeg \
      libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 使用清华 pip 镜像
COPY requirements.txt .
RUN pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# Benchmark 可选依赖
RUN pip install -i https://pypi.tuna.tsinghua.edu.cn/simple funasr-onnx psutil edge-tts noisereduce || true

COPY src/ ./src/
COPY scripts/ ./scripts/
COPY configs/ ./configs/
COPY data/ ./data/

RUN mkdir -p data/benchmark data/models data/uploads data/outputs

CMD ["python", "scripts/benchmark_asr.py", "--help"]
